# Credits Usage Summary App
This app enables a customer to produce summarized credits reporting in their own Sumo account for the following:
- logs (continuous, frequent, infrequent, CSE) using data volume
- metrics using data volume
- tracing using data volume
- infrequent scan using search audit
- storage: create a fixed daily estimate taken from the account page.

Use these dashboards to estimate your sumologic credits usage for logs, metrics and traces using the current consumption rate per day, and provide longer term views than can be easily generated by default. This is useful if the year to date estimate on the account page is inaccurate vs current rate of use. 

The app also includes sample alerts for credits over plan rate, abnormal spike in a credit Unit of Measure or infrequent scans outside fixed thresholds.

Customizing the setup with account specific numbers is advisable however you can get going immediately just by importing the app via the library import feature. Required search schedules to save to view and lookup will be created in one simple step.

## Dashboards
- Daily Ingest Burn Rate (Data Volume Raw) - Realtime view using the raw data volume index data. This will work well for recent time but will load very slowly compared to the view or lookups based dashboards.
- Credits View (credits_usage_hourly) - A summary using the hourly view. This dashboard uses a view _view=credits_usage_hourly_v* derived from two data sources: the datavolume with tier index per ingestion index/partition, and the search audit index. 

![credits view](./credits.view.dashboard.png?raw=true "credits view")

- Long Term Credits Report (credits_report lookup) - Shows long term estimates of credits usage in your account using a lookup table. The lookup table is built daily by the scheduled search 'Credits Report' using a view created by scheduled searches that aggregate data from the data volume indexes. Since it usese a timeless lookup you can dashboard > 31 day Sumo limit.

![long term lookup dash](./long.term.credits.dashboard.png?raw=true "long term lookup dash")
## Setup
WARNING! The view contains columns that count as fields in sumo.  If you previously created fields in your sumo account( fields or view fields) with the **same names** but different data types you will need to modify the searches and the app to use different column names to avoid data type errors in your account. Get your sumo account team to check if you are unsure.
- _timeslice (long)
- rate(Double)
- unit(String)
- units(Double)
- uom(String)

### 1. Set account specific values
We can setup the defaults on the dashboards now, or manully fix the default in sumo after importing the app later by editing the dashboard temaplate defaults. 

To fix before import: 
- Open the ```credits_usage_summary_app.json``` file in a text editor.
- from your contract or administration/account page locate your annual credits amount, anniversary date and term days 
 replace the value following values using global text/replace:
- 21900 -  your annual credits number.
- 365 -  your term days (usually it will be same)
- 2023/03/11 - your anniversary date (yyyy/mm/dd)
save the ```credits_usage_summary_app.json``` file 

### 2. Import the credits_usage_summary_app.json from step 1 into your account.
There are two items referenced in the app that must exist before we import it or import will fail with errors.

- run the query in ```create_view.sumo``` to create 1 row in the view. 
- wait a couple of minutes for the _view to exist then run the query ```create_lookup.sumo``` to create the lookup table. 

Now we can import that app. Chose a good shared location (Admin Recommended / Sumo Admin is a good place) where it has permissions to be managed by Sumo admins.

Open the LIbrary at the correct parent folder
Choose import option
For name use "Credits Usage Summary App"
paste the contents of ```credits_usage_summary_app.json``` into the data box and click Import button.

After importing you now should see the folder and contents in the library.

### 3. (optional) Create a storage estimate in the view
Storage is hard to estimate in a Sumo account so it's best just to use fixed values from the account page.

Review your Administration / Account page and determine typical daily GB number for storage for storage and storage infrequent.

In the Views folder open the ```credits_usage_storage_estimated``` and ```credits_usage_storage_estimated_backfill``` searches and modify these to match your typical daily in this section replacing 1 with your daily GB number:
```
// take these numbers from your account page
| 1 as daily_storage_gb
| 1 as daily_storage_gb_infrequent
```

### 4. (optional) Backfill view data
Thi step creates a history for the dashboards immediately vs waiting for history to build up over time from the  schedules. We can do this by running the backfill searches in the views folder in the library.

In the views folder open each backfill search and execute it for the number of days you want to have initial history for. 

WARNING! It's very important to be careful not to backfill the same time period more than once. Doing so will duplicate volume in the view for those times.

For example if you want 14d initial history choose -14d. 

As you open each search :
- **click Cancel** on the save dialog
- set the retention time
- run the query and choose to Save in the save dialog.


### 5. Set lookup history 
Wait a few minutes then run the ```Lookup_Report/Create_Report``` search to create an initial data set.  Each day from now on this will happen via a schedule.

Open the Lookup_Report folder and edit the credits_report search schedule. By default this is set to -90d but you may want to use a longer number for more history to build up over time. Bear in mind it's a v1 lookup at max allowed size is 8MB.

### 6. (optional) Schedule alerts.
Some optional alerts are provided but not scheduled in this app.
In the Alerts folder configure and schedule relevant alerts.
1. **Alert - Abnormal rate of credits consumption** (uses hourly view and time compare to detect anomaly vs previous trends)
2. **Alert - Daily credits trend exceeds plan size.** (uses daily lookup file)
3. **Alert: Abnormal Infrequent Scan Credits** (uses raw search audit data.)


## Solution
## Hourly aggregated credits dataset in a view
A set of hourly scheduled searches summarizes data volume for each credit type to the view credits_hourly_v1. You can find these searches in the view subfolder. A dashboard is provided that uses this view enabling fast reporting in the 7-31 day range by credit Unit of Measure (UOM) down to 1 hour granularity.

## Long term aggregated dataset in a lookup
A once per day search scans the view and creates a lookup table with one row per day and totals for each credit Unit of Measure (UOM). This facilitates long term executive level reporting in a sumo dashboard (avoiding the 31 day dashboard limit).

###  view credits_usage_hourly_v1
The hourly view name is ```_view=credits_usage_hourly_v1```
It has the following columns:
- _timeslice (long)
- rate(Double)
- unit(String)
- units(Double)
- uom(String)

Example data:
```
05/05/2022 11:00:00.000 AM +1200	0.00786	0.003	dpm	62.91667	metrics
05/05/2022 11:00:00.000 AM +1200	6.25000e-5	0.0015	gbytes/day	0.04167	storage_infrequent
05/05/2022 11:00:00.000 AM +1200	0	0.0015	gbytes/day	0	storage_security
```

### lookup /shared/lookups/credits_report
```/shared/lookups/credits_report``` lookup table is generated daily by the credits_report search. By producing a timeless summary we can dashboard for longer than 31d. 
